#!/bin/bash
# åŒ»ç–—VLMå®Œæ•´è®­ç»ƒå’Œéƒ¨ç½²è„šæœ¬
# åŒ…å«ï¼šæ•°æ®å‡†å¤‡ -> LoRAè®­ç»ƒ -> æ¨¡åž‹åˆå¹¶ -> éƒ¨ç½²åˆ°LM Studio

set -e

echo "=================================================="
echo "ðŸ¥ åŒ»ç–—è§†è§‰è¯­è¨€æ¨¡åž‹è®­ç»ƒä¸Žéƒ¨ç½²"
echo "=================================================="

cd "$(dirname "$0")"
source venv/bin/activate

# é…ç½®
MODEL_PATH="/Users/plutoguo/.lmstudio/models/lmstudio-community/Qwen3-VL-30B-A3B-Instruct-MLX-4bit"
ADAPTER_PATH="./adapters"
OUTPUT_MODEL="/Users/plutoguo/.lmstudio/models/local/Qwen3-VL-30B-Medical-Finetuned"

# æ­¥éª¤1: å‡†å¤‡æ•°æ®ï¼ˆåŒ…å«å¥–æƒ©æœºåˆ¶ï¼‰
echo ""
echo "ðŸ“¦ æ­¥éª¤1: å‡†å¤‡è®­ç»ƒæ•°æ®ï¼ˆåŒ…å«å¥–æƒ©æœºåˆ¶ï¼‰..."
python prepare_data.py

# æ­¥éª¤2: LoRAè®­ç»ƒ
echo ""
echo "ðŸš€ æ­¥éª¤2: å¼€å§‹LoRAè®­ç»ƒ (1000æ­¥)..."
echo "è¿™å¯èƒ½éœ€è¦30-60åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…..."
mlx_lm.lora --config lora_config.yaml

# æ­¥éª¤3: åˆå¹¶æ¨¡åž‹
echo ""
echo "ðŸ”§ æ­¥éª¤3: åˆå¹¶LoRAä¸ŽåŸºç¡€æ¨¡åž‹..."
mkdir -p "$OUTPUT_MODEL"

mlx_lm.fuse \
    --model "$MODEL_PATH" \
    --adapter-path "$ADAPTER_PATH" \
    --save-path "$OUTPUT_MODEL" \
    --de-quantize

# æ­¥éª¤4: åˆ›å»ºæ¨¡åž‹é…ç½®
echo ""
echo "ðŸ“ æ­¥éª¤4: åˆ›å»ºLM Studioé…ç½®..."
cat > "$OUTPUT_MODEL/README.md" << 'EOF'
# Qwen3-VL-30B åŒ»ç–—å¾®è°ƒç‰ˆ

## æ¨¡åž‹ä¿¡æ¯
- åŸºç¡€æ¨¡åž‹: Qwen3-VL-30B-A3B-Instruct-MLX-4bit
- å¾®è°ƒæ–¹å¼: LoRA
- è®­ç»ƒæ•°æ®: åŒ»ç–—é—®ç­”æ•°æ®é›†
- ç‰¹ç‚¹: å›žç­”ç²¾å‡†ã€å¯Œæœ‰äººæƒ…å‘³

## è®­ç»ƒç‰¹ç‚¹
1. **ç›‘ç£å¼å­¦ä¹ ** - ä½¿ç”¨é«˜è´¨é‡åŒ»ç–—é—®ç­”å¯¹
2. **å¥–æƒ©æœºåˆ¶** - å¥–åŠ±äººæƒ…å‘³è¡¨è¾¾ï¼Œæƒ©ç½šå†·æ¼ /æ­¦æ–­å›žå¤
3. **äººæƒ…å‘³å¢žå¼º** - è®­ç»ƒæ¨¡åž‹è¡¨è¾¾åŒç†å¿ƒå’Œå…³æ€€

## ä½¿ç”¨æ–¹å¼
åœ¨LM Studioä¸­ç›´æŽ¥åŠ è½½æ­¤æ¨¡åž‹å³å¯ä½¿ç”¨ã€‚
æ”¯æŒå›¾åƒå’Œæ–‡æœ¬è¾“å…¥ã€‚

## å›žå¤é£Žæ ¼
- å…ˆè¡¨è¾¾ç†è§£å’Œå…³å¿ƒ
- æä¾›ä¸“ä¸šåˆ†æž
- ä½¿ç”¨é€šä¿—è¯­è¨€è§£é‡Š
- é€‚å½“ç»™äºˆé¼“åŠ±
- æé†’å¿…è¦æ—¶å°±åŒ»
EOF

echo ""
echo "=================================================="
echo "ðŸŽ‰ è®­ç»ƒå’Œéƒ¨ç½²å®Œæˆ!"
echo "=================================================="
echo "æ¨¡åž‹å·²ä¿å­˜åˆ°: $OUTPUT_MODEL"
echo ""
echo "åœ¨LM Studioä¸­åŠ è½½æ¨¡åž‹å³å¯ä½¿ç”¨"
echo "æ¨¡åž‹æ”¯æŒå›¾åƒå’Œæ–‡æœ¬è¾“å…¥"

