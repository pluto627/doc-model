# 🎯 V3精准度强化训练指南

## 📌 概述

这是基于V2-Fused模型的第三次训练，目标是：
- ✅ **大幅提升精准度**（权重：2.0）
- ✅ **保持人情味不变**（权重：1.0）
- ✅ **训练5200步**（超过要求的5000步）

---

## 🚀 快速开始

### 方法1: 一键启动（推荐）

```bash
cd /Users/plutoguo/Desktop/training
./run_v3_training.sh
```

这个脚本会：
1. 检查环境和数据
2. 确认训练配置
3. 自动开始训练
4. 显示训练进度
5. 保存结果和日志

### 方法2: 手动启动

```bash
cd /Users/plutoguo/Desktop/training
source venv/bin/activate
python train_v3_precision.py --steps 5200
```

---

## ⚙️ 训练配置

### 核心参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `--base-model` | V2-Fused路径 | 基础模型 |
| `--steps` | 5200 | 训练步数 |
| `--batch-size` | 2 | 批次大小 |
| `--lr` | 3e-6 | 学习率（精细调整） |
| `--lora-rank` | 128 | LoRA秩 |
| `--precision-weight` | 2.0 | 精准度权重 ⭐ |
| `--empathy-weight` | 1.0 | 人情味权重 ⭐ |

### 训练阶段

训练分为3个阶段，每个阶段有不同的侧重点：

#### Phase 1 (0-2000步): 精准度核心强化
- **重点**: 医学术语准确性、数值精度
- **精准度权重**: 2.0 × 1.5 = 3.0
- **人情味权重**: 1.0 × 0.8 = 0.8
- **目标**: 建立强大的精准度基础

#### Phase 2 (2000-4000步): 医学知识深化
- **重点**: 诊断置信度、治疗方案具体性
- **精准度权重**: 2.0 × 1.3 = 2.6
- **人情味权重**: 1.0 × 0.9 = 0.9
- **目标**: 深化医学专业性

#### Phase 3 (4000-5200步): 精度+人情味平衡
- **重点**: 综合平衡调优
- **精准度权重**: 2.0 × 1.0 = 2.0
- **人情味权重**: 1.0 × 1.0 = 1.0
- **目标**: 达到最佳平衡点

---

## 📊 精准度评估标准

V3训练使用以下指标评估精准度：

### 1. 医学术语准确性 (Medical Term Accuracy)
- **高价值术语**: 诊断名称、检查项目、治疗方案
- **中等价值术语**: 通用医学词汇
- **专业术语**: 血压、血糖、肝功能等

### 2. 数值精度 (Numerical Precision)
- **数值范围**: 120-140, 3.5-5.5
- **带单位数值**: 140 mmHg, 7.2 mmol/L
- **结构化数值**: 140/90, 均值±标准差

### 3. 诊断置信度 (Diagnosis Confidence)
- 明确的诊断相关词汇
- 包含实验室数值
- 专业分析判断

### 4. 治疗具体性 (Treatment Specificity)
- 具体药物名称
- 详细治疗方案
- 分步骤操作指南

### 5. 人情味保持 (Empathy Maintenance)
- 同理心表达
- 温暖安慰
- 情绪支持

---

## 📁 输出文件

训练完成后会生成以下文件：

```
training/
├── adapters_v3_precision/          # LoRA权重（主要输出）
│   ├── adapters.safetensors
│   └── adapter_config.json
│
├── finetuned_model_v3_precision/   # 模型配置
│   ├── training_config.json        # 训练配置
│   ├── metrics_history.json        # 训练指标历史
│   └── README.md                   # 模型说明
│
├── checkpoints_v3_precision/       # 训练检查点
│   ├── step_200/
│   ├── step_400/
│   └── ...
│
└── logs/                           # 训练日志
    └── training_v3_precision_*.log
```

---

## 🧪 测试模型

### 1. 命令行快速测试

```bash
cd /Users/plutoguo/Desktop/training
source venv/bin/activate

# 使用adapter（推荐）
mlx_lm.chat --model /Users/plutoguo/.lmstudio/models/local/Qwen3-VL-30B-Medical-V2-Fused --adapter-path adapters_v3_precision

# 或单次生成
mlx_lm.generate \
  --model /Users/plutoguo/.lmstudio/models/local/Qwen3-VL-30B-Medical-V2-Fused \
  --adapter-path adapters_v3_precision \
  --prompt "我的血压140/90需要担心吗？" \
  --max-tokens 300
```

### 2. 运行评估脚本

```bash
python evaluate_v3_model.py
```

这会测试5个典型场景：
1. 血压咨询（数值精准度）
2. 血糖检查（详细分析）
3. 药物咨询（具体方案）
4. 症状分析（综合判断）
5. 情绪支持（人情味）

### 3. 测试问题示例

**测试精准度**：
```
Q: 我的空腹血糖是7.2 mmol/L，这个值高吗？
期望: 明确指出超过正常值（3.9-6.1 mmol/L），给出具体建议
```

**测试人情味保持**：
```
Q: 刚确诊高血压，很担心以后怎么办...
期望: 同理心表达 + 具体治疗方案 + 情绪支持
```

---

## 🔄 融合模型（用于LM Studio）

训练完成后，需要融合才能在LM Studio中使用：

```bash
python fuse_v3_model.py
```

融合过程：
1. 加载V2-Fused基础模型
2. 加载V3 adapters
3. 融合权重
4. 保存到：`/Users/plutoguo/.lmstudio/models/local/Qwen3-VL-30B-Medical-V3-Precision`
5. 重启LM Studio即可使用

---

## 📈 预期效果

### 相比V2的改进

| 指标 | V2 | V3 (目标) | 提升 |
|------|-----|-----------|------|
| 医学术语准确性 | ★★★★☆ | ★★★★★ | +20% |
| 数值精度 | ★★★☆☆ | ★★★★★ | +40% |
| 诊断置信度 | ★★★★☆ | ★★★★★ | +20% |
| 治疗具体性 | ★★★☆☆ | ★★★★★ | +40% |
| 人情味表达 | ★★★★☆ | ★★★★☆ | 0% (保持) |
| **综合得分** | **3.6** | **4.6** | **+28%** |

### V3的核心优势

1. **极高精准度**
   - 准确的医学术语使用
   - 精确的数值和范围
   - 明确的诊断判断
   - 详细的治疗方案

2. **保持温暖**
   - 同理心不减
   - 语气依然温和
   - 情绪支持到位

3. **最佳平衡**
   - 专业性 + 人性化
   - 精准 + 温暖
   - 科学 + 关怀

---

## ⚠️ 注意事项

### 训练前检查

1. **数据检查**
```bash
wc -l data_mlx/train.jsonl data_mlx/valid.jsonl
# 应该看到: 4000行训练数据, 500行验证数据
```

2. **基础模型检查**
```bash
ls -lh /Users/plutoguo/.lmstudio/models/local/Qwen3-VL-30B-Medical-V2-Fused/
# 应该看到: config.json, model-*.safetensors等文件
```

3. **磁盘空间检查**
```bash
df -h .
# 需要至少20GB可用空间
```

### 训练中监控

1. **查看实时日志**
```bash
tail -f logs/training_v3_precision_*.log
```

2. **检查GPU使用**（如果使用GPU）
```bash
nvidia-smi  # 或 Apple Silicon: powermetrics
```

3. **训练时间估算**
- MLX训练: 约2-4小时
- 模拟训练: 约5-10分钟

### 训练后验证

1. **检查adapter文件**
```bash
ls -lh adapters_v3_precision/
# 应该有: adapters.safetensors (约200-500MB)
```

2. **查看训练曲线**
```bash
python -c "
import json
with open('finetuned_model_v3_precision/metrics_history.json') as f:
    metrics = json.load(f)
    print(f'训练步数: {len(metrics)}')
    print(f'最终loss: {metrics[-1][\"loss\"]:.4f}')
"
```

---

## 🛠️ 故障排查

### 问题1: 基础模型不存在

**错误**: `❌ 基础模型不存在: .../Qwen3-VL-30B-Medical-V2-Fused`

**解决**:
```bash
# 方案1: 使用原始基础模型
python train_v3_precision.py \
  --base-model /Users/plutoguo/.lmstudio/models/lmstudio-community/Qwen3-VL-30B-Medical-Finetuned \
  --adapter-path adapters_v2

# 方案2: 先融合V2模型
# （参考之前的融合脚本）
```

### 问题2: 内存不足

**错误**: Memory error / OOM

**解决**:
```bash
# 减小批次大小
python train_v3_precision.py --batch-size 1

# 或减小LoRA rank
python train_v3_precision.py --lora-rank 64
```

### 问题3: MLX不可用

**错误**: `MLX未安装`

**解决**:
```bash
# 安装MLX
pip install mlx mlx-lm

# 如果还是不行，会自动使用模拟模式
# 模拟模式适合测试流程，但不会真正训练
```

### 问题4: 训练中断

**解决**:
```bash
# V3训练会定期保存检查点
# 从最近的检查点继续训练（需要修改代码支持）
# 或者重新开始训练
```

---

## 📞 快速参考

### 常用命令

```bash
# 1. 开始训练
./run_v3_training.sh

# 2. 测试模型
mlx_lm.chat --model <base-model> --adapter-path adapters_v3_precision

# 3. 评估模型
python evaluate_v3_model.py

# 4. 融合模型
python fuse_v3_model.py

# 5. 查看日志
tail -f logs/training_v3_precision_*.log

# 6. 检查进度
ls -lh checkpoints_v3_precision/
```

### 参数调整建议

如果需要**更高精准度**：
```bash
python train_v3_precision.py \
  --precision-weight 3.0 \
  --empathy-weight 0.8 \
  --steps 6000
```

如果需要**更多人情味**：
```bash
python train_v3_precision.py \
  --precision-weight 1.5 \
  --empathy-weight 1.5 \
  --steps 5200
```

---

## 🎯 总结

V3训练的核心思路：

1. **明确目标**: 精准度↑↑，人情味→
2. **分阶段训练**: 循序渐进，逐步优化
3. **量化评估**: 多维度指标，客观衡量
4. **灵活调整**: 可根据需要调整权重

训练完成后，你将获得：
- ✅ 极高精准度的医疗咨询模型
- ✅ 保持温暖的人性化交流
- ✅ 专业且关怀并重的AI助手

---

**开始训练吧！** 🚀

有任何问题，查看日志文件或README文档。



